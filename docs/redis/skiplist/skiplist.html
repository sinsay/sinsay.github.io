<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- common.css -->
  <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: Arial, Helvetica, sans-serif;margin: 0;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 85%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre {margin: 0;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
  <!-- ace-static.css -->
  <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
  <style>.ace-monokai .ace_gutter {background: #2F3129;color: #8F908A}.ace-monokai .ace_print-margin {width: 1px;background: #555651}.ace-monokai {background-color: #272822;color: #F8F8F2}.ace-monokai .ace_cursor {color: #F8F8F0}.ace-monokai .ace_marker-layer .ace_selection {background: #49483E}.ace-monokai.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px #272822;border-radius: 2px}.ace-monokai .ace_marker-layer .ace_step {background: rgb(102, 82, 0)}.ace-monokai .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid #49483E}.ace-monokai .ace_marker-layer .ace_active-line {background: #202020}.ace-monokai .ace_gutter-active-line {background-color: #272727}.ace-monokai .ace_marker-layer .ace_selected-word {border: 1px solid #49483E}.ace-monokai .ace_invisible {color: #52524d}.ace-monokai .ace_entity.ace_name.ace_tag,.ace-monokai .ace_keyword,.ace-monokai .ace_meta.ace_tag,.ace-monokai .ace_storage {color: #F92672}.ace-monokai .ace_punctuation,.ace-monokai .ace_punctuation.ace_tag {color: #fff}.ace-monokai .ace_constant.ace_character,.ace-monokai .ace_constant.ace_language,.ace-monokai .ace_constant.ace_numeric,.ace-monokai .ace_constant.ace_other {color: #AE81FF}.ace-monokai .ace_invalid {color: #F8F8F0;background-color: #F92672}.ace-monokai .ace_invalid.ace_deprecated {color: #F8F8F0;background-color: #AE81FF}.ace-monokai .ace_support.ace_constant,.ace-monokai .ace_support.ace_function {color: #66D9EF}.ace-monokai .ace_fold {background-color: #A6E22E;border-color: #F8F8F2}.ace-monokai .ace_storage.ace_type,.ace-monokai .ace_support.ace_class,.ace-monokai .ace_support.ace_type {font-style: italic;color: #66D9EF}.ace-monokai .ace_entity.ace_name.ace_function,.ace-monokai .ace_entity.ace_other,.ace-monokai .ace_entity.ace_other.ace_attribute-name,.ace-monokai .ace_variable {color: #A6E22E}.ace-monokai .ace_variable.ace_parameter {font-style: italic;color: #FD971F}.ace-monokai .ace_string {color: #E6DB74}.ace-monokai .ace_comment {color: #75715E}.ace-monokai .ace_indent-guide {background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQImWPQ0FD0ZXBzd/wPAAjVAoxeSgNeAAAAAElFTkSuQmCC) right repeat-y}</style>
  <!-- export.css -->
  <style>
    body{margin:0 auto;max-width:800px;line-height:1.4}
    #nav{margin:5px 0 10px;font-size:15px}
    #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
    #contentarea{font-size:15px;margin:16px 0}
    .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
    .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
    .latex-cell{white-space:pre-wrap;}
  </style>
  <!-- User CSS -->
  <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
</head>
<body>
  
  <div id="titlearea">
    <h2>skiplist</h2>
  </div>
  <div id="contentarea"><div class="cell text-cell"></div><div class="cell markdown-cell"><h1 id="-">跳跃表</h1>
<p>[TOC]</p>
<h2 id="-">介绍</h2>
<p>跳跃表是一种有序的列表，可以提供平均 O(logN)、最差 O(N) 复杂度的查找性能，而且相对于 AVL 跟 RB Tree 之类的结构来说有两大优势：</p>
<ul>
<li>实现简单很多</li><li>平均性能差不多</li></ul>
<p>所以有不少的实现在实现有序的 Set 时，更倾向于使用跳跃表，而且跳跃表在搜索引擎的实现中也占很重要的一部分。</p>
<p>在这里我们选择使用 <strong>redis 的跳跃表</strong>实现来对齐进行分析。<br>首先我们介绍一下他的大致结构</p>
<p><img src="./image/skiplist_linklist_complete.png" alt=""></p>
<p>如图所示，所谓的跳跃表，即是在有序的列表中，加入了跳跃使用的指针，以允许从当前节点直接访问后续的其他节点，而不是只能通过遍历的形式来访问其他节点。<br>接着我们再看看他的基本定义：</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">跳</span><span class="ace_cjk" style="width:20px">跃</span><span class="ace_cjk" style="width:20px">表</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">定</span><span class="ace_cjk" style="width:20px">义</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span>&nbsp;<span class="ace_storage ace_type">struct</span>&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">void</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span><span class="ace_punctuation ace_operator">;</span>&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">值</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">double</span>&nbsp;<span class="ace_identifier">score</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">分</span><span class="ace_cjk" style="width:20px">值</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">struct</span>&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">backward</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">向</span><span class="ace_cjk" style="width:20px">上</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">struct</span>&nbsp;<span class="ace_identifier">zskiplistLevel</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">struct</span>&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">unsigned</span>&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">span</span><span class="ace_punctuation ace_operator">;</span>&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">跃</span><span class="ace_cjk" style="width:20px">度</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">也</span><span class="ace_cjk" style="width:20px">就</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">跳</span><span class="ace_cjk" style="width:20px">跃</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">距</span><span class="ace_cjk" style="width:20px">离</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>&nbsp;<span class="ace_identifier">level</span>&nbsp;<span class="ace_paren ace_lparen">[</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>&nbsp;<span class="ace_identifier">zskiplistNode</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">跳</span><span class="ace_cjk" style="width:20px">跃</span><span class="ace_cjk" style="width:20px">表</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">定</span><span class="ace_cjk" style="width:20px">义</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span>&nbsp;<span class="ace_storage ace_type">struct</span>&nbsp;<span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">struct</span>&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">tail</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">unsigned</span>&nbsp;<span class="ace_storage ace_type">long</span>&nbsp;<span class="ace_identifier">length</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>&nbsp;<span class="ace_identifier">zskiplist</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></div><div class="cell markdown-cell"><p>整个跳跃表由 zskiplistNode 跟 zskiplist 组成；<br>zskiplist 负责管理整个链表的情况，如使用 header 跟 tail 来提供正反两个方向的遍历。<br>使用 length 来保存列表中 item 的数目，并使用 level 来提示算法，当前跳跃表的最高层数<br><strong><em>需要注意的是，header 永远是有 MAX 层的，所以 header 的层数不计入 level 中。</em></strong></p>
<h2 id="-">实现</h2>
<h3 id="-skiplist">创建 skiplist</h3>
<p>接着是 zskiplistNode 的介绍</p>
<ul>
<li>obj 是保存对象的指针</li><li>score 是当前对象的分值，也就是用于排序的依据，这个一般会由内部算法生成，一般是为了提供区间搜索，比如得到某个分值区间的数据。</li><li><strong>综合以上两点，排序有两种方式，一种是依据 obj 本身的比较函数，另一种是依据 score</strong></li></ul>
<p><strong>所以在下面的例子中，避免复杂度，所有的测试都以 score 为准</strong></p>
<p>接下来我们从代码层面开始分析，首先是 skiplist 的初始化</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zslCreateNode</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">double</span>&nbsp;<span class="ace_identifier">score</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">void</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zn</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zmalloc</span><span class="ace_paren ace_lparen">(</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zn</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_keyword ace_operator">*</span>&nbsp;<span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">*</span>&nbsp;<span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">struct</span>&nbsp;<span class="ace_identifier">zskiplistLevel</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zn</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">score</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zn</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">obj</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">obj</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_identifier">zn</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zslCreate</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">j</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">于</span>&nbsp;zmalloc&nbsp;<span class="ace_cjk" style="width:20px">可</span><span class="ace_cjk" style="width:20px">以</span><span class="ace_cjk" style="width:20px">理</span><span class="ace_cjk" style="width:20px">解</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">就</span><span class="ace_cjk" style="width:20px">是</span>&nbsp;malloc&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">简</span><span class="ace_cjk" style="width:20px">单</span><span class="ace_cjk" style="width:20px">封</span><span class="ace_cjk" style="width:20px">装</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">以</span><span class="ace_cjk" style="width:20px">便</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">随</span><span class="ace_cjk" style="width:20px">时</span><span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">改</span><span class="ace_cjk" style="width:20px">内</span><span class="ace_cjk" style="width:20px">存</span><span class="ace_cjk" style="width:20px">分</span><span class="ace_cjk" style="width:20px">配</span><span class="ace_cjk" style="width:20px">器</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zmalloc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zsl</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">length</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">这</span><span class="ace_cjk" style="width:20px">里</span><span class="ace_cjk" style="width:20px">即</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">分</span><span class="ace_cjk" style="width:20px">配</span><span class="ace_cjk" style="width:20px">出</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">有</span>&nbsp;ZSKIPLIST_MAXLEVEL&nbsp;<span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">作</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;header</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">并</span><span class="ace_cjk" style="width:20px">把</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">建</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;score&nbsp;<span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;0<span class="ace_cjk" style="width:20px">，</span>obj&nbsp;<span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;NULL</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">正</span><span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">上</span><span class="ace_cjk" style="width:20px">面</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">说</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">，</span>header&nbsp;<span class="ace_cjk" style="width:20px">本</span><span class="ace_cjk" style="width:20px">身</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">不</span><span class="ace_cjk" style="width:20px">列</span><span class="ace_cjk" style="width:20px">入</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">数</span><span class="ace_cjk" style="width:20px">计</span><span class="ace_cjk" style="width:20px">算</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">并</span><span class="ace_cjk" style="width:20px">且</span><span class="ace_cjk" style="width:20px">不</span><span class="ace_cjk" style="width:20px">存</span><span class="ace_cjk" style="width:20px">放</span><span class="ace_cjk" style="width:20px">任</span><span class="ace_cjk" style="width:20px">何</span>&nbsp;obj&nbsp;<span class="ace_cjk" style="width:20px">的</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslCreateNode</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ZSKIPLIST_MAXLEVEL</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">j</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">j</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">ZSKIPLIST_MAXLEVEL</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">j</span><span class="ace_keyword ace_operator">++</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">j</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">j</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">backward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">tail</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></div><div class="cell markdown-cell"><p>通过以上函数，调用 zslCreate 之后，即可得到一个初始化完成的 skiplist，结构大致如下</p>
<div id="init_state"></div>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;<span class="ace_identifier">_____</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_identifier">level</span>&nbsp;&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="ace_identifier">MAX</span>&nbsp;|&nbsp;<span class="ace_keyword ace_operator">--&gt;</span>&nbsp;<span class="ace_identifier">NULL</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_identifier">length</span>&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;.&nbsp;&nbsp;|&nbsp;<span class="ace_keyword ace_operator">--&gt;</span>&nbsp;<span class="ace_identifier">NULL</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_identifier">header</span>&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">-------&gt;</span>&nbsp;&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_identifier">score</span>&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;.&nbsp;&nbsp;|&nbsp;<span class="ace_keyword ace_operator">--&gt;</span>&nbsp;<span class="ace_identifier">NULL</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">[</span>&nbsp;&nbsp;<span class="ace_identifier">tail</span>&nbsp;&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">NULL</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_identifier">obj</span>&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">NULL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;.&nbsp;&nbsp;|&nbsp;<span class="ace_keyword ace_operator">--&gt;</span>&nbsp;<span class="ace_identifier">NULL</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_identifier">level</span>&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">---------&gt;</span>&nbsp;|&nbsp;&nbsp;<span class="ace_constant ace_numeric">1</span>&nbsp;&nbsp;|&nbsp;<span class="ace_keyword ace_operator">--&gt;</span>&nbsp;<span class="ace_identifier">NULL</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;|&nbsp;&nbsp;<span class="ace_constant ace_numeric">0</span>&nbsp;&nbsp;|&nbsp;<span class="ace_keyword ace_operator">--&gt;</span>&nbsp;<span class="ace_identifier">NULL</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;|<span class="ace_identifier">_____</span>|
</div></div></div></div><div class="cell markdown-cell"><h3 id="-">插入数据</h3>
<p>接下来我们通过测试代码来逐步分析 skiplist 在进行操作时会有什么动作</p>
<div id="testcode"></div>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">初</span><span class="ace_cjk" style="width:20px">始</span><span class="ace_cjk" style="width:20px">化</span><span class="ace_cjk" style="width:20px">要</span><span class="ace_cjk" style="width:20px">插</span><span class="ace_cjk" style="width:20px">入</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">象</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">array</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">10</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">array</span><span class="ace_paren ace_rparen">)</span>&nbsp;/&nbsp;<span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">int</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">++</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">array</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">+</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">sl</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslCreate</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">node</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslInsert</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">sl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">array</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">array</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">node2</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslInsert</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">sl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">array</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">array</span>&nbsp;<span class="ace_keyword ace_operator">+</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div></div></div></div><div class="cell markdown-cell"><p>上面的代码我们初始化了一个包含 10 个数字的数字，作为 obj 来插入列表<br>然后测试插入了两个元素，包括第一个 score 为 1 obj 为 1 的对象，以及第二个 score 为 2 obj 为 2 的对象。<br>接下来我们先分析下， <code>zslInsert</code> 到底做了什么。</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zslInsert</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">double</span>&nbsp;<span class="ace_identifier">score</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">void</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;x&nbsp;<span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">处</span><span class="ace_cjk" style="width:20px">理</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;update&nbsp;<span class="ace_cjk" style="width:20px">数</span><span class="ace_cjk" style="width:20px">组</span><span class="ace_cjk" style="width:20px">保</span><span class="ace_cjk" style="width:20px">存</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">是</span>:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">小</span><span class="ace_cjk" style="width:20px">于</span>&nbsp;<span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">向</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">大</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span>&nbsp;span</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">ZSKIPLIST_MAXLEVEL</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">unsigned</span>&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">ZSKIPLIST_MAXLEVEL</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">首</span><span class="ace_cjk" style="width:20px">先</span><span class="ace_cjk" style="width:20px">获</span><span class="ace_cjk" style="width:20px">取</span>&nbsp;header</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">从</span><span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span>&nbsp;skiplist&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">开</span><span class="ace_cjk" style="width:20px">始</span><span class="ace_cjk" style="width:20px">查</span><span class="ace_cjk" style="width:20px">找</span><span class="ace_cjk" style="width:20px">合</span><span class="ace_cjk" style="width:20px">适</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">位</span><span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">因</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">越</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">向</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">目</span><span class="ace_cjk" style="width:20px">标</span><span class="ace_cjk" style="width:20px">就</span><span class="ace_cjk" style="width:20px">可</span><span class="ace_cjk" style="width:20px">能</span><span class="ace_cjk" style="width:20px">越</span><span class="ace_cjk" style="width:20px">远</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_constant ace_numeric">-1</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&gt;=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">--</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;storea&nbsp;rank&nbsp;that&nbsp;is&nbsp;crossed&nbsp;to&nbsp;reach&nbsp;the&nbsp;insert&nbsp;position</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">保</span><span class="ace_cjk" style="width:20px">存</span>&nbsp;rank&nbsp;???</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_constant ace_numeric">-1</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_punctuation ace_operator">?</span>&nbsp;<span class="ace_constant ace_numeric">0</span>&nbsp;<span class="ace_punctuation ace_operator">:</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_constant ace_numeric">+1</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">增</span><span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">象</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;score&nbsp;<span class="ace_cjk" style="width:20px">小</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;score</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">或</span>&nbsp;score&nbsp;<span class="ace_cjk" style="width:20px">相</span><span class="ace_cjk" style="width:20px">等</span><span class="ace_cjk" style="width:20px">但</span>&nbsp;compare&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">结</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">小</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;obj</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">这</span><span class="ace_cjk" style="width:20px">里</span><span class="ace_cjk" style="width:20px">使</span><span class="ace_cjk" style="width:20px">用</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">因</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">从</span>&nbsp;header&nbsp;<span class="ace_cjk" style="width:20px">开</span><span class="ace_cjk" style="width:20px">始</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">而</span>&nbsp;header&nbsp;<span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">存</span><span class="ace_cjk" style="width:20px">实</span><span class="ace_cjk" style="width:20px">际</span>&nbsp;obj&nbsp;<span class="ace_cjk" style="width:20px">的</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">while</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">||</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">compareStringObjects</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">obj</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">))</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_comment">//&nbsp;rank&nbsp;<span class="ace_cjk" style="width:20px">加</span><span class="ace_cjk" style="width:20px">上</span><span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">跨</span><span class="ace_cjk" style="width:20px">度</span><span class="ace_cjk" style="width:20px">？</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">+=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">保</span><span class="ace_cjk" style="width:20px">存</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">到</span>&nbsp;update&nbsp;<span class="ace_cjk" style="width:20px">中</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">建</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">给</span><span class="ace_cjk" style="width:20px">予</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">随</span><span class="ace_cjk" style="width:20px">机</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">级</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslRandomLevel</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">数</span><span class="ace_cjk" style="width:20px">大</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">现</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">大</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">现</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">旧</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">次</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">&gt;</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">++</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">旧</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">次</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">让</span><span class="ace_cjk" style="width:20px">其</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">向</span>&nbsp;header,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">并</span><span class="ace_cjk" style="width:20px">让</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">第</span>&nbsp;i&nbsp;<span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;span&nbsp;<span class="ace_cjk" style="width:20px">跨</span><span class="ace_cjk" style="width:20px">度</span><span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;zsl&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">数</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">也</span><span class="ace_cjk" style="width:20px">就</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">直</span><span class="ace_cjk" style="width:20px">接</span><span class="ace_cjk" style="width:20px">跨</span><span class="ace_cjk" style="width:20px">越</span><span class="ace_cjk" style="width:20px">到</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">后</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">length</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span>&nbsp;skiplist&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">为</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">终</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">到</span><span class="ace_cjk" style="width:20px">创</span><span class="ace_cjk" style="width:20px">建</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">这</span><span class="ace_cjk" style="width:20px">步</span><span class="ace_cjk" style="width:20px">了</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">创</span><span class="ace_cjk" style="width:20px">建</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span>&nbsp;level&nbsp;<span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">并</span><span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">好</span>&nbsp;sroce&nbsp;<span class="ace_cjk" style="width:20px">跟</span>&nbsp;obj</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslCreateNode</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">score</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">低</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">旧</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">次</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">++</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span>&nbsp;x&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">第</span>&nbsp;i&nbsp;<span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">向</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">-</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">-</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">])</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">-</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">])</span>&nbsp;<span class="ace_keyword ace_operator">+</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">跨</span><span class="ace_cjk" style="width:20px">度</span><span class="ace_cjk" style="width:20px">增</span><span class="ace_cjk" style="width:20px">加</span>&nbsp;1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">++</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">后</span><span class="ace_cjk" style="width:20px">退</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">针</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">第</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;NULL(<span class="ace_cjk" style="width:20px">因</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">没</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">上</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">了</span><span class="ace_cjk" style="width:20px">）</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">否</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;update[0]&nbsp;??</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">backward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_punctuation ace_operator">?</span>&nbsp;<span class="ace_constant ace_language">NULL</span>&nbsp;<span class="ace_punctuation ace_operator">:</span>&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">后</span><span class="ace_cjk" style="width:20px">退</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">针</span><span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">backward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">没</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">说</span><span class="ace_cjk" style="width:20px">明</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">后</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">tail</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">length</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></div><div class="cell markdown-cell"><p>redis 的 skiplist 的插入代码较长，所以我们分段进行分析，并且在分析的时候已我们的测试代码为准，如我们现在即将调用的</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;array[0]&nbsp;=&nbsp;1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;array&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1&nbsp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">node</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslInsert</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">sl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">array</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">array</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></div><div class="cell markdown-cell"><p>首先从 <a href="#init_state">初始化图</a> 可以得知 skiplist 现在的状态，接下来逐步分析插入的代码，<br>我们向 sl 插入了 score 为 1，obj 指向 1 的信息，接下来进入函数的第一步骤</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;level&nbsp;<span class="ace_cjk" style="width:20px">是</span>&nbsp;1,&nbsp;<span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">以</span><span class="ace_cjk" style="width:20px">只</span><span class="ace_cjk" style="width:20px">会</span><span class="ace_cjk" style="width:20px">循</span><span class="ace_cjk" style="width:20px">环</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">次</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">并</span><span class="ace_cjk" style="width:20px">且</span>&nbsp;i&nbsp;=&nbsp;0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_constant ace_numeric">-1</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&gt;=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">--</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">以</span><span class="ace_cjk" style="width:20px">这</span><span class="ace_cjk" style="width:20px">里</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;rank[i]&nbsp;=&nbsp;0;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_constant ace_numeric">-1</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_punctuation ace_operator">?</span>&nbsp;<span class="ace_constant ace_numeric">0</span>&nbsp;<span class="ace_punctuation ace_operator">:</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_constant ace_numeric">+1</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">而</span><span class="ace_cjk" style="width:20px">这</span><span class="ace_cjk" style="width:20px">里</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;forward&nbsp;<span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">开</span><span class="ace_cjk" style="width:20px">始</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;NULL&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">以</span><span class="ace_cjk" style="width:20px">不</span><span class="ace_cjk" style="width:20px">会</span><span class="ace_cjk" style="width:20px">进</span><span class="ace_cjk" style="width:20px">入</span><span class="ace_cjk" style="width:20px">循</span><span class="ace_cjk" style="width:20px">环</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">while</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">||</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">compareStringObjects</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">obj</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">))</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">+=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></div><div class="cell markdown-cell"><p>所以执行完之后，各变量的状态转为</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">update</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_punctuation ace_operator">...</span>&nbsp;<span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">rank</span>&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_punctuation ace_operator">...</span>&nbsp;<span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></div><div class="cell markdown-cell"><p>并假设新节点的层级由随机数得到 3，则下面的第二步骤的具体细节为</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslRandomLevel</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">假</span><span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;3</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span>&nbsp;zsl-&gt;level&nbsp;<span class="ace_cjk" style="width:20px">为</span>&nbsp;1<span class="ace_cjk" style="width:20px">，</span>&nbsp;<span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">以</span><span class="ace_cjk" style="width:20px">进</span><span class="ace_cjk" style="width:20px">入</span><span class="ace_cjk" style="width:20px">循</span><span class="ace_cjk" style="width:20px">环</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">&gt;</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">这</span><span class="ace_cjk" style="width:20px">边</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">循</span><span class="ace_cjk" style="width:20px">环</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">定</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;update&nbsp;<span class="ace_cjk" style="width:20px">跟</span>&nbsp;rank</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">++</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">旧</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">次</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">让</span><span class="ace_cjk" style="width:20px">其</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">向</span>&nbsp;header,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">并</span><span class="ace_cjk" style="width:20px">让</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">第</span>&nbsp;i&nbsp;<span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;span&nbsp;<span class="ace_cjk" style="width:20px">跨</span><span class="ace_cjk" style="width:20px">度</span><span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;zsl&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">数</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">也</span><span class="ace_cjk" style="width:20px">就</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">直</span><span class="ace_cjk" style="width:20px">接</span><span class="ace_cjk" style="width:20px">跨</span><span class="ace_cjk" style="width:20px">越</span><span class="ace_cjk" style="width:20px">到</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">后</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">length</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span>&nbsp;skiplist&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">为</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></div><div class="cell markdown-cell"><p>执行完后，各变量的状态转为</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">3</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">update</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_punctuation ace_operator">...</span>&nbsp;<span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">rank</span>&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_punctuation ace_operator">...</span>&nbsp;<span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">header</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">header</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">2</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></div><div class="cell markdown-cell"><p>接下来是插入的最后一个步骤了，这里会依据 update 的内容来更新 skiplist，并且会往其中加入新节点</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">创</span><span class="ace_cjk" style="width:20px">建</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslCreateNode</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">score</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">++</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">各</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;forward&nbsp;<span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">应</span>&nbsp;update&nbsp;<span class="ace_cjk" style="width:20px">的</span>&nbsp;forward</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">并</span><span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">原</span><span class="ace_cjk" style="width:20px">有</span>&nbsp;update&nbsp;<span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;forward&nbsp;<span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">向</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">各</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;span&nbsp;<span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">原</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">应</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;span&nbsp;<span class="ace_cjk" style="width:20px">并</span><span class="ace_cjk" style="width:20px">减</span><span class="ace_cjk" style="width:20px">去</span>&nbsp;rank[0]&nbsp;-&nbsp;rank[i];</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">-</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">-</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">])</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">然</span><span class="ace_cjk" style="width:20px">后</span><span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">原</span><span class="ace_cjk" style="width:20px">有</span>&nbsp;update&nbsp;<span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">应</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;span&nbsp;<span class="ace_cjk" style="width:20px">为</span>&nbsp;rank[0]&nbsp;-&nbsp;rank[i]&nbsp;+&nbsp;1<span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">也</span><span class="ace_cjk" style="width:20px">就</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">应</span><span class="ace_cjk" style="width:20px">的</span>&nbsp;span&nbsp;<span class="ace_cjk" style="width:20px">加</span><span class="ace_cjk" style="width:20px">上</span>1&nbsp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">-</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">])</span>&nbsp;<span class="ace_keyword ace_operator">+</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">跨</span><span class="ace_cjk" style="width:20px">度</span><span class="ace_cjk" style="width:20px">增</span><span class="ace_cjk" style="width:20px">加</span>&nbsp;1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">++</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">后</span><span class="ace_cjk" style="width:20px">退</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">针</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">第</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;NULL(<span class="ace_cjk" style="width:20px">因</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">没</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">上</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">了</span><span class="ace_cjk" style="width:20px">）</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">否</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">为</span>&nbsp;update[0]&nbsp;??</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">backward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_punctuation ace_operator">?</span>&nbsp;<span class="ace_constant ace_language">NULL</span>&nbsp;<span class="ace_punctuation ace_operator">:</span>&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">后</span><span class="ace_cjk" style="width:20px">退</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">针</span><span class="ace_cjk" style="width:20px">设</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">backward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_control">else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">没</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">说</span><span class="ace_cjk" style="width:20px">明</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">后</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">tail</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">length</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></div><div class="cell markdown-cell"><p>这次调用马上结束了，最后来看看这次的调用结果，将 zsl 这个 skiplist 变成什么样了，</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>x&nbsp;=&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;backward:&nbsp;NULL,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;score&nbsp;&nbsp;&nbsp;:&nbsp;<span class="ace_constant ace_numeric">3</span>,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;obj&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span class="ace_constant ace_numeric">3</span>,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;level&nbsp;&nbsp;&nbsp;:&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;NULL,&nbsp;...&nbsp;<span class="ace_paren ace_rparen">]</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>zsl&nbsp;=&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;leve&nbsp;&nbsp;:&nbsp;<span class="ace_constant ace_numeric">3</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;length:&nbsp;<span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;header:&nbsp;-----&gt;&nbsp;&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;score&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;=&nbsp;<span class="ace_constant ace_numeric">0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;tail&nbsp;&nbsp;:&nbsp;x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;obj&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;=&nbsp;NULL
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;level&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;=&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;...&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>zsl-&gt;header.level&nbsp;=&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">{</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;____&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;span:&nbsp;<span class="ace_constant ace_numeric">1</span>,&nbsp;forward&nbsp;----&gt;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;|
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;x&nbsp;|
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">{</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;<span class="ace_constant ace_numeric">3</span>&nbsp;|
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;span:&nbsp;<span class="ace_constant ace_numeric">1</span>,&nbsp;forward&nbsp;----&gt;&nbsp;&nbsp;|&nbsp;&nbsp;<span class="ace_constant ace_numeric">3</span>&nbsp;|
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;|
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">{</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;|
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;span:&nbsp;<span class="ace_constant ace_numeric">1</span>,&nbsp;forward&nbsp;----&gt;&nbsp;&nbsp;|____|
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">]</span>
</div></div></div></div><div class="cell markdown-cell"><p>接下来分析第二次插入时的情况，这次我们就不逐步分析，而是直接查看插入后的结果了。<br>首先是对第一步骤的分析，我们现在要插入的节点是 score = 3, obj = 3，在执行完第一步骤后继续执行第二步骤，根据新节点的随机 level 填充 update 跟更新 skiplist 的 level, 我们假设新节点的随机层数为 2 ，则执行代码</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zslInsert</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">array</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">2</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">array</span>&nbsp;<span class="ace_keyword ace_operator">+</span>&nbsp;<span class="ace_constant ace_numeric">2</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_comment">//&nbsp;3,&nbsp;3</span>
</div></div></div></div><div class="cell markdown-cell"><!--
x = header;
zsl->level = 3;
rank = [ 0, 0, 0, ... ]

第一次循环 i == 2

rank[2] = 0;
rank[2] = x->level[2].span = 1
x = x->level[2].forward = { score: 1, obj: 1, level: [ NULL, ... ] }
rank = [0, 0, 1, ...]
update = [ NULL, NULL, { 1, 1 }, ...]

第二次循环 i == 1
rank[1] = rank[2] = 1
update[1] = x = { 1, 1 }
rank = [0, 1, 1]
update = [ NULL, { 1, 1 }, { 1, 1}, ... ]

第三次循环 i == 0
rank[0] = rank[1] = 1
update[i] = { 1, 1 }
rank = [ 1, 1, 1 ]
update = [ { 1, 1 }, { 1, 1 }, { 1, 1 } ]

level = 2, 因为 level < zsl->level 所以没进入循环
-->
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>x&nbsp;=&nbsp;<span class="ace_paren ace_lparen">{</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zsl&nbsp;=&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;backward:&nbsp;NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;level:&nbsp;<span class="ace_constant ace_numeric">3</span>,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;score:&nbsp;<span class="ace_constant ace_numeric">3</span>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;length:&nbsp;<span class="ace_constant ace_numeric">1</span>,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;obj&nbsp;&nbsp;:&nbsp;<span class="ace_constant ace_numeric">3</span>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header:&nbsp;------&gt;&nbsp;header,
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;level:&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;empty,&nbsp;...&nbsp;<span class="ace_paren ace_rparen">]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>level&nbsp;=&nbsp;<span class="ace_constant ace_numeric">2</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>rank&nbsp;=&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_constant ace_numeric">1</span>,&nbsp;<span class="ace_constant ace_numeric">1</span>,&nbsp;<span class="ace_constant ace_numeric">1</span>,&nbsp;...&nbsp;<span class="ace_paren ace_rparen">]</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_invalid ace_illegal">//&nbsp;update&nbsp;<span class="ace_cjk" style="width:20px">列</span><span class="ace_cjk" style="width:20px">表</span><span class="ace_cjk" style="width:20px">中</span><span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">象</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">指</span>&nbsp;{&nbsp;level,&nbsp;score,&nbsp;obj&nbsp;}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>update&nbsp;=&nbsp;<span class="ace_paren ace_lparen">[</span>&nbsp;<span class="ace_paren ace_lparen">{</span>&nbsp;<span class="ace_constant ace_numeric">3</span>,&nbsp;<span class="ace_constant ace_numeric">3</span>,&nbsp;<span class="ace_constant ace_numeric">3</span>&nbsp;<span class="ace_paren ace_rparen">}</span>,&nbsp;<span class="ace_paren ace_lparen">{</span>&nbsp;<span class="ace_constant ace_numeric">3</span>,&nbsp;<span class="ace_constant ace_numeric">3</span>,&nbsp;<span class="ace_constant ace_numeric">3</span>&nbsp;<span class="ace_paren ace_rparen">}</span>,&nbsp;<span class="ace_paren ace_lparen">{</span>&nbsp;<span class="ace_constant ace_numeric">3</span>,&nbsp;<span class="ace_constant ace_numeric">3</span>,&nbsp;<span class="ace_constant ace_numeric">3</span>&nbsp;<span class="ace_paren ace_rparen">}</span>,&nbsp;...&nbsp;<span class="ace_paren ace_rparen">]</span>
</div></div></div></div><div class="cell markdown-cell"><p>第三步骤，则负责更新整个 update 对应的对象，以及新对象的指针</p>
<p>&lt;!--<br>for 0 -&gt; 2<br>第一次循环 i = 0<br>x-&gt;level[0].forward = update[0]-&gt;level[0].forward; = NULL<br>update[0]-&gt;level[0].forward = x<br>x-&gt;level[0].span = update[0].level[0].span = 0 - (rank[0] - rank[0]) = 0<br>update[0].level[i].span = (rank[0] - rank[0] + 1 = 1</p>
<p>总共三步循环都是把旧有节点指向 x，并更新对应的指针跟 rank</p>
<p>x-&gt;backward = (update[0]) = { 1, ,1 1 }<br>zsl-&gt;tail = x<br>zsl-&gt;length++;<br>--&gt;<br><img src="./image/skiplist_status1.jpg" alt="状态1"></p>
<p>下面我们继续插入新的数据节点，这次插入的是另一个节点</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zslInsert</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">array</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">array</span>&nbsp;<span class="ace_keyword ace_operator">+</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_comment">//&nbsp;2,&nbsp;2</span>
</div></div></div></div><div class="cell markdown-cell"><p>并且我们假设其随机生成的层数 level 为 4 层，则插入之后 skiplist 的状态为</p>
<!--
x = header;
循环3次
i == 2
rank[2] = 0;
rank[2] = 1
x = { 1, 1, 1 }
update[2] = { 1, 1, 1 }

i == 1
rank[1] = 1
x = { 1, 1, 1 }
update[1] = { 1, 1, 1 }

i == 0
rank[i] = 1
x = { 1, 1, 1 }
update[0] = { 1, 1, 1 }

level = 4
for ( i = 3 ; i < 4; i++) {
update...
}
rank[3] = 0;
update[3] = header
update[3]->level[3].span = 2

rank = [1, 1, 1, 0, ...]
update = [ {1,1,1}, {1,1,1}, {1,1,1}, {0,0,0} ]
zsl->level = 4

x = { 4, 2, 2 } // level 4, score 2, obj 2
for(i = 0; i < 4; i++) {
}
x->level[0].forward = update[0]->level[0].forward;
x->level[0].forward = {1,1,1}[0].forward; = {3,3,3}

x->level[0].span = update[0]->level[0].span - (rank[0] - rank[0])
                 = {1,1,1}[0].span - 0 = 0

x->level[1].forward = update[1]->level[1].forward
x->level[1].forward = {1,1,1}[1].forward;
x->level[1].span = update[1]->level[1].span - (rank[0] - rank[1])
                 = {1,1,1}[1].span - (1-1) = 0

x->level[2].forward = update[2]->level[2].forward;
x->level[2].forward = {1,1,1}[2].forward;
x->level[2].span = update[2]->level[2].span - (rank[0] - rank[2])
                 = {1,1,1}[2].span - (1-1) = 0

x->level[3].forward = update[3]->level[3].forward 
                 = header[3].forward = NULL                 
x->level[3].span = header[3].span - (0 - rank[3]) = 1                 

-->

<p><img src="./image/skiplist_status2.jpg" alt=""></p>
<h3 id="-">查找数据</h3>
<p>插入一定量的数据之后，整个 skiplist 树已经趋于稳定状态，现在我们开始来介绍下查找数据的流程，同样的，我们还是以测试代码为驱动，来分析具体的查找流程，一下是测试代码</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">函</span><span class="ace_cjk" style="width:20px">数</span><span class="ace_cjk" style="width:20px">原</span><span class="ace_cjk" style="width:20px">型</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span><span class="ace_keyword ace_operator">*</span>&nbsp;<span class="ace_identifier">zslGetElementByRank</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">unsigned</span>&nbsp;<span class="ace_storage ace_type">long</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">测</span><span class="ace_cjk" style="width:20px">试</span><span class="ace_cjk" style="width:20px">代</span><span class="ace_cjk" style="width:20px">码</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">node</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">node</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslGetElementByRank</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_constant ace_numeric">2</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">获</span><span class="ace_cjk" style="width:20px">取</span><span class="ace_cjk" style="width:20px">排</span><span class="ace_cjk" style="width:20px">名</span><span class="ace_cjk" style="width:20px">第</span><span class="ace_cjk" style="width:20px">二</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">元</span><span class="ace_cjk" style="width:20px">素</span></span>
</div></div></div></div><div class="cell markdown-cell"><p>因为整个 skiplist 都是有序的，所以最简单的查找方式就是从头开始找（<em>当然也可以从后面开始找，这样就可以换一种顺序来得到数据了，但我们为了简单只讨论第一种</em>），但因为 skiplist 为我们提供了指向多级节点之后的指针，我们才能提高查找的效率。<br>从上面的结构图我们可以看到，从层数来分析，层级越高的元素，能够跨越的距离就越远，所以在进行搜索的时候我们会倾向于从最高点开始往下找，这样就能充分利用 skiplist 为我们提供的效率。<br>接下来继续看看 skiplist 的查找实现</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span><span class="ace_keyword ace_operator">*</span>&nbsp;<span class="ace_identifier">zslGetElementByRank</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">unsigned</span>&nbsp;<span class="ace_storage ace_type">long</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">unsigned</span>&nbsp;<span class="ace_storage ace_type">long</span>&nbsp;<span class="ace_identifier">traversed</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">从</span><span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">开</span><span class="ace_cjk" style="width:20px">始</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">遍</span><span class="ace_cjk" style="width:20px">历</span><span class="ace_cjk" style="width:20px">所</span><span class="ace_cjk" style="width:20px">有</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">层</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_constant ace_numeric">-1</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&gt;=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">--</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">跟</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">距</span><span class="ace_cjk" style="width:20px">离</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">小</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">我</span><span class="ace_cjk" style="width:20px">们</span><span class="ace_cjk" style="width:20px">想</span><span class="ace_cjk" style="width:20px">查</span><span class="ace_cjk" style="width:20px">找</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">位</span><span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">，</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">向</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">并</span><span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">已</span><span class="ace_cjk" style="width:20px">经</span><span class="ace_cjk" style="width:20px">跨</span><span class="ace_cjk" style="width:20px">越</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">距</span><span class="ace_cjk" style="width:20px">离</span><span class="ace_cjk" style="width:20px">加</span><span class="ace_cjk" style="width:20px">上</span><span class="ace_cjk" style="width:20px">当</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">跟</span><span class="ace_cjk" style="width:20px">下</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">距</span><span class="ace_cjk" style="width:20px">离</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">while</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">&amp;&amp;</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">traversed</span>&nbsp;<span class="ace_keyword ace_operator">+</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">&lt;=</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_rparen">))</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">traversed</span>&nbsp;<span class="ace_keyword ace_operator">+=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">找</span><span class="ace_cjk" style="width:20px">到</span><span class="ace_cjk" style="width:20px">了</span><span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">应</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">级</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">traversed</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_identifier">rank</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></div><div class="cell markdown-cell"><p>具体的实现也是跟设定的逻辑一致，从最高层开始最小化查找的次数。</p>
<h4 id="-">查找的另一种方式</h4>
<p>接下来看另外一个实现，查找某个元素，因为保存的是 <code>void*</code> 指针，所以就导致了，必须提供自定义的比较函数，否则就会使用直接比较指针地址的方式。</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">函</span><span class="ace_cjk" style="width:20px">数</span><span class="ace_cjk" style="width:20px">原</span><span class="ace_cjk" style="width:20px">型</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span>&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">cmpfunc</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">void</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">y</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span><span class="ace_keyword ace_operator">*</span>&nbsp;<span class="ace_identifier">zslGetNode</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">void</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">cmpfunc</span>&nbsp;<span class="ace_identifier">cmp</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">cmp</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">xp</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">void</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">yp</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">xp</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">y</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">yp</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_identifier">y</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">else</span>&nbsp;<span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">y</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_constant ace_numeric">-1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">else</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">开</span><span class="ace_cjk" style="width:20px">始</span><span class="ace_cjk" style="width:20px">查</span><span class="ace_cjk" style="width:20px">找</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">3</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">node</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zslGetNode</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">i</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">cmp</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div></div></div></div><div class="cell markdown-cell"><p>为了便于理解，我们首先把查找的过程以图形的方式画出。</p>
<p><img src="./image/skiplist_status3.jpg" alt=""></p>
<p>查找方式跟之前的还是相同的，区别就只是不再按 score 查找，而是根据 obj 之间的 cmp 函数，来决定是要使用当前层往前找，还是使用第一层的指针往前找而已。下面是具体的查找代码</p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">zskiplistNode</span><span class="ace_keyword ace_operator">*</span>&nbsp;<span class="ace_identifier">zslGetNode</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">void</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">cmpfunc</span>&nbsp;<span class="ace_identifier">cmp</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">c</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&gt;=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">--</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">while</span>&nbsp;<span class="ace_paren ace_lparen">(</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">c</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">cmp</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">))</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">c</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>&nbsp;<span class="ace_comment">//&nbsp;found&nbsp;it!</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></div><div class="cell markdown-cell"><h3 id="-">删除</h3>
<p>看完上面的所有介绍后，其实可以很容易的就联想到，关于 skiplist 的操作，基本都是基于其中的 update 指针，也就是那个指向指定节点 x 的前置节点集合。只要得到这个集合，要删除某个操作时，只需要将 update 指针指向 x 的节点，改成指向 x 对应层级的下一层就可以了，而高度高于 x 节点的，则只需要将 span 减少。<br><em>redis 的源码中给出的是针对某个 score 的 robj 的比较</em></p>
</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">zslDelete</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_storage ace_type">double</span>&nbsp;<span class="ace_identifier">score</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">robj</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">ZSKIPLIST_MAXLEVEL</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">首</span><span class="ace_cjk" style="width:20px">先</span><span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span>&nbsp;update&nbsp;<span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">向</span><span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">应</span>&nbsp;score&nbsp;<span class="ace_cjk" style="width:20px">跟</span>&nbsp;obj&nbsp;<span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">前</span><span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_constant ace_numeric">-1</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&gt;=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">--</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">while</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">sroce</span>&nbsp;<span class="ace_keyword ace_operator">||</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_identifier">compareStringObjects</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">obj</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)))</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">将</span>&nbsp;x&nbsp;<span class="ace_cjk" style="width:20px">置</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">要</span><span class="ace_cjk" style="width:20px">删</span><span class="ace_cjk" style="width:20px">除</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">目</span><span class="ace_cjk" style="width:20px">标</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">终</span><span class="ace_cjk" style="width:20px">判</span><span class="ace_cjk" style="width:20px">断</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">终</span><span class="ace_cjk" style="width:20px">找</span><span class="ace_cjk" style="width:20px">到</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">是</span><span class="ace_cjk" style="width:20px">否</span><span class="ace_cjk" style="width:20px">为</span><span class="ace_cjk" style="width:20px">目</span><span class="ace_cjk" style="width:20px">标</span><span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">象</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span>&nbsp;<span class="ace_keyword ace_operator">&amp;&amp;</span>&nbsp;<span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">score</span>&nbsp;<span class="ace_keyword ace_operator">&amp;&amp;</span>&nbsp;<span class="ace_identifier">equalStringObjects</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">obj</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">))</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">调</span><span class="ace_cjk" style="width:20px">用</span>&nbsp;deleteNode&nbsp;<span class="ace_cjk" style="width:20px">删</span><span class="ace_cjk" style="width:20px">除</span><span class="ace_cjk" style="width:20px">对</span><span class="ace_cjk" style="width:20px">应</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">然</span><span class="ace_cjk" style="width:20px">后</span><span class="ace_cjk" style="width:20px">释</span><span class="ace_cjk" style="width:20px">放</span><span class="ace_cjk" style="width:20px">内</span><span class="ace_cjk" style="width:20px">存</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zslDeleteNode</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zslFreeNode</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">return</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_comment">//&nbsp;not&nbsp;found</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">void</span>&nbsp;<span class="ace_identifier">zslDeleteNode</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zskiplist</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zsl</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">*</span><span class="ace_identifier">x</span><span class="ace_punctuation ace_operator">,</span>&nbsp;<span class="ace_identifier">zskiplistNode</span>&nbsp;<span class="ace_keyword ace_operator">**</span><span class="ace_identifier">update</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_storage ace_type">int</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">for</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span>&nbsp;<span class="ace_keyword ace_operator">&lt;</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_punctuation ace_operator">;</span>&nbsp;<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">++</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">次</span><span class="ace_cjk" style="width:20px">低</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">或</span><span class="ace_cjk" style="width:20px">等</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">即</span><span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">删</span><span class="ace_cjk" style="width:20px">除</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">针</span><span class="ace_cjk" style="width:20px">以</span><span class="ace_cjk" style="width:20px">及</span><span class="ace_cjk" style="width:20px">跨</span><span class="ace_cjk" style="width:20px">度</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">+=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">-</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">else</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">层</span><span class="ace_cjk" style="width:20px">次</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">于</span><span class="ace_cjk" style="width:20px">即</span><span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">删</span><span class="ace_cjk" style="width:20px">除</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">直</span><span class="ace_cjk" style="width:20px">接</span><span class="ace_cjk" style="width:20px">减</span><span class="ace_cjk" style="width:20px">少</span><span class="ace_cjk" style="width:20px">一</span><span class="ace_cjk" style="width:20px">个</span><span class="ace_cjk" style="width:20px">跨</span><span class="ace_cjk" style="width:20px">度</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">update</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">span</span>&nbsp;<span class="ace_keyword ace_operator">-=</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">更</span><span class="ace_cjk" style="width:20px">新</span><span class="ace_cjk" style="width:20px">即</span><span class="ace_cjk" style="width:20px">将</span><span class="ace_cjk" style="width:20px">删</span><span class="ace_cjk" style="width:20px">除</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">指</span><span class="ace_cjk" style="width:20px">针</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">if</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_paren ace_rparen">)</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">backward</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">backward</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">else</span>&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">tail</span>&nbsp;<span class="ace_keyword ace_operator">=</span>&nbsp;<span class="ace_identifier">x</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">backward</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_comment">//&nbsp;<span class="ace_cjk" style="width:20px">如</span><span class="ace_cjk" style="width:20px">果</span><span class="ace_cjk" style="width:20px">删</span><span class="ace_cjk" style="width:20px">除</span><span class="ace_cjk" style="width:20px">节</span><span class="ace_cjk" style="width:20px">点</span><span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">度</span><span class="ace_cjk" style="width:20px">是</span>&nbsp;skiplist&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">最</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">度</span><span class="ace_cjk" style="width:20px">，</span><span class="ace_cjk" style="width:20px">则</span><span class="ace_cjk" style="width:20px">尝</span><span class="ace_cjk" style="width:20px">试</span><span class="ace_cjk" style="width:20px">调</span><span class="ace_cjk" style="width:20px">整</span>&nbsp;skiplist&nbsp;<span class="ace_cjk" style="width:20px">的</span><span class="ace_cjk" style="width:20px">高</span><span class="ace_cjk" style="width:20px">度</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_keyword ace_control">while</span>&nbsp;<span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">&gt;</span>&nbsp;<span class="ace_constant ace_numeric">1</span>&nbsp;<span class="ace_keyword ace_operator">&amp;&amp;</span>&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">header</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span>&nbsp;<span class="ace_keyword ace_operator">-</span>&nbsp;<span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">forward</span>&nbsp;<span class="ace_keyword ace_operator">==</span>&nbsp;<span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span>&nbsp;&nbsp;<span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_identifier">zsl</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">level</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></div><div class="cell markdown-cell"></div></div>
  <script></script>
</body>
</html>